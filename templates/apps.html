<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº”ç”¨ç®¡ç† - UniMCPSim</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <!-- Monaco Editor Local -->
    <script src="/static/js/monaco-editor/vs/loader.js"></script>
</head>
<body>
{% include '_navigation.html' %}

    <div class="container mt-3">
        <div class="card card-action-bar">
            <div class="d-flex justify-between align-center">
                <h2 class="card-header">åº”ç”¨åˆ—è¡¨</h2>
                <button onclick="showCreateModal()" class="btn btn-primary btn-sm">åˆ›å»ºæ–°åº”ç”¨</button>
            </div>
        </div>

        <div class="card">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ç±»åˆ«</th>
                        <th>åç§°</th>
                        <th>æ˜¾ç¤ºåç§°</th>
                        <th>è·¯å¾„</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="appsList">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- åˆ›å»ºåº”ç”¨æ¨¡æ€æ¡† -->
    <div id="createModal" class="modal">
        <div class="modal-content large">
            <h3 class="modal-title">åˆ›å»ºæ–°åº”ç”¨</h3>
            <form id="createAppForm">
                <div class="modal-split">
                    <!-- å·¦ä¾§ï¼šåŸºæœ¬ä¿¡æ¯ -->
                    <div>
                        <h4 style="color: var(--primary-100); margin-bottom: 1rem;">åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="form-group">
                            <label class="form-label">ç±»åˆ«</label>
                            <input type="text" name="category" class="form-control" required placeholder="ä¾‹å¦‚ï¼šIM, Network, Security">
                        </div>
                        <div class="form-group">
                            <label class="form-label">åç§°</label>
                            <input type="text" name="name" class="form-control" required placeholder="ä¾‹å¦‚ï¼šWeChat, Cisco3750">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ˜¾ç¤ºåç§°</label>
                            <input type="text" name="display_name" class="form-control" required placeholder="ä¾‹å¦‚ï¼šä¼ä¸šå¾®ä¿¡">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea name="description" class="form-control" rows="3" placeholder="åº”ç”¨çš„è¯¦ç»†æè¿°"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ™ºèƒ½ç”Ÿæˆæç¤ºè¯</label>
                            <textarea id="createPrompt" class="form-control" rows="4" placeholder="æè¿°éœ€è¦ç”Ÿæˆçš„åŠ¨ä½œï¼Œä¾‹å¦‚ï¼š
å·¥å…·1: æŸ¥è¯¢é˜²ç«å¢™å¥åº·çŠ¶æ€
å·¥å…·2: å°ç¦ä¸€ä¸ªIPåœ°å€
å·¥å…·3: è§£å°ä¸€ä¸ªIPåœ°å€
å·¥å…·4: æŸ¥è¯¢IPæ˜¯å¦è¢«å°ç¦"></textarea>
                            <button type="button" id="generateActions" class="btn btn-secondary" style="margin-top: 0.5rem;">
                                ğŸ¤– è‡ªåŠ¨ç”ŸæˆåŠ¨ä½œå®šä¹‰
                            </button>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šåŠ¨ä½œå®šä¹‰ -->
                    <div>
                        <h4 style="color: var(--primary-100); margin-bottom: 1rem;">åŠ¨ä½œå®šä¹‰</h4>
                        <div class="form-group">
                            <label class="form-label">JSONæ ¼å¼åŠ¨ä½œé…ç½®</label>
                            <div id="createActionsEditor" class="monaco-editor-container"></div>
                            <textarea id="createActions" name="actions" style="display: none;"></textarea>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--bg-300);">
                    <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                    <button type="button" onclick="hideModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘åº”ç”¨æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content large">
            <h3 class="modal-title">ç¼–è¾‘åº”ç”¨</h3>
            <form id="editAppForm">
                <input type="hidden" id="editAppId">
                <div class="modal-split">
                    <!-- å·¦ä¾§ï¼šåŸºæœ¬ä¿¡æ¯ -->
                    <div>
                        <h4 style="color: var(--primary-100); margin-bottom: 1rem;">åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="form-group">
                            <label class="form-label">ç±»åˆ«</label>
                            <input type="text" id="editCategory" name="category" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">åç§°</label>
                            <input type="text" id="editName" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ˜¾ç¤ºåç§°</label>
                            <input type="text" id="editDisplayName" name="display_name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea id="editDescription" name="description" class="form-control" rows="6"></textarea>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šåŠ¨ä½œå®šä¹‰ -->
                    <div>
                        <h4 style="color: var(--primary-100); margin-bottom: 1rem;">åŠ¨ä½œå®šä¹‰</h4>
                        <div class="form-group">
                            <label class="form-label">JSONæ ¼å¼åŠ¨ä½œé…ç½®</label>
                            <div id="editActionsEditor" class="monaco-editor-container"></div>
                            <textarea id="editActions" name="actions" style="display: none;"></textarea>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--bg-300);">
                    <button type="submit" class="btn btn-primary">æ›´æ–°åº”ç”¨</button>
                    <button type="button" onclick="hideEditModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let editActionsEditor = null;
        let createActionsEditor = null;

        // åˆå§‹åŒ–Monaco Editor
        require.config({ paths: { vs: '/static/js/monaco-editor/vs' } });
        require(['vs/editor/editor.main'], function () {
            // ç¼–è¾‘æ¨¡æ€æ¡†çš„Monaco Editor
            editActionsEditor = monaco.editor.create(document.getElementById('editActionsEditor'), {
                value: '[\n  {\n    "name": "action_name",\n    "display_name": "åŠ¨ä½œæ˜¾ç¤ºå",\n    "description": "åŠ¨ä½œæè¿°",\n    "parameters": [\n      {\n        "key": "param_name",\n        "type": "String",\n        "required": true,\n        "description": "å‚æ•°æè¿°"\n      }\n    ]\n  }\n]',
                language: 'json',
                theme: 'vs-dark',
                fontSize: 14,
                lineNumbers: 'on',
                minimap: { enabled: false },
                automaticLayout: true,
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                formatOnType: true,
                formatOnPaste: true,
                tabSize: 2,
                insertSpaces: true
            });

            // ç›‘å¬ç¼–è¾‘å™¨å†…å®¹å˜åŒ–ï¼ŒåŒæ­¥åˆ°éšè—çš„textarea
            editActionsEditor.onDidChangeModelContent(() => {
                const textarea = document.getElementById('editActions');
                textarea.value = editActionsEditor.getValue();
            });

            // åˆ›å»ºæ¨¡æ€æ¡†çš„Monaco Editor
            createActionsEditor = monaco.editor.create(document.getElementById('createActionsEditor'), {
                value: '[\n  {\n    "name": "example_action",\n    "display_name": "ç¤ºä¾‹åŠ¨ä½œ",\n    "description": "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹åŠ¨ä½œ",\n    "parameters": [\n      {\n        "key": "input",\n        "type": "String",\n        "required": true,\n        "description": "è¾“å…¥å‚æ•°"\n      }\n    ]\n  }\n]',
                language: 'json',
                theme: 'vs-dark',
                fontSize: 14,
                lineNumbers: 'on',
                minimap: { enabled: false },
                automaticLayout: true,
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                formatOnType: true,
                formatOnPaste: true,
                tabSize: 2,
                insertSpaces: true
            });

            // ç›‘å¬åˆ›å»ºç¼–è¾‘å™¨å†…å®¹å˜åŒ–ï¼ŒåŒæ­¥åˆ°éšè—çš„textarea
            createActionsEditor.onDidChangeModelContent(() => {
                const textarea = document.getElementById('createActions');
                textarea.value = createActionsEditor.getValue();
            });
        });

        async function loadApps() {
            try {
                const response = await fetch('/admin/api/apps');
                const apps = await response.json();
                const tbody = document.getElementById('appsList');

                tbody.innerHTML = apps.map(app => `
                    <tr>
                        <td>${app.id}</td>
                        <td>${app.category}</td>
                        <td>${app.name}</td>
                        <td>${app.display_name}</td>
                        <td>/${app.category}/${app.name}</td>
                        <td>
                            <span class="badge ${app.enabled ? 'badge-success' : 'badge-danger'}">
                                ${app.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                            </span>
                        </td>
                        <td>
                            <button onclick="editApp(${app.id})" class="btn btn-sm btn-secondary">ç¼–è¾‘</button>
                            <button onclick="toggleApp(${app.id}, ${!app.enabled})" class="btn btn-sm btn-secondary">
                                ${app.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button onclick="deleteApp(${app.id})" class="btn btn-sm btn-danger">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load apps:', error);
            }
        }

        function showCreateModal() {
            document.getElementById('createModal').classList.add('show');
        }

        function hideModal() {
            document.getElementById('createModal').classList.remove('show');
        }

        function hideEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function editApp(id) {
            try {
                const response = await fetch(`/admin/api/apps/${id}`);
                const app = await response.json();

                document.getElementById('editAppId').value = app.id;
                document.getElementById('editCategory').value = app.category;
                document.getElementById('editName').value = app.name;
                document.getElementById('editDisplayName').value = app.display_name;
                document.getElementById('editDescription').value = app.description || '';

                // è®¾ç½®Monaco Editorçš„å†…å®¹
                const actionsJson = JSON.stringify(app.template?.actions || [], null, 2);
                if (editActionsEditor) {
                    editActionsEditor.setValue(actionsJson);
                } else {
                    // å¦‚æœMonaco Editorè¿˜æ²¡åˆå§‹åŒ–ï¼Œè®¾ç½®åˆ°textareaä½œä¸ºåå¤‡
                    document.getElementById('editActions').value = actionsJson;
                }

                document.getElementById('editModal').classList.add('show');
            } catch (error) {
                console.error('Failed to load app details:', error);
                alert('åŠ è½½åº”ç”¨è¯¦æƒ…å¤±è´¥');
            }
        }

        // AIç”ŸæˆåŠ¨ä½œå®šä¹‰
        document.getElementById('generateActions').addEventListener('click', async () => {
            const category = document.querySelector('#createAppForm input[name="category"]').value;
            const name = document.querySelector('#createAppForm input[name="name"]').value;
            const display_name = document.querySelector('#createAppForm input[name="display_name"]').value;
            const description = document.querySelector('#createAppForm textarea[name="description"]').value;
            const prompt = document.getElementById('createPrompt').value;

            if (!prompt.trim()) {
                alert('è¯·å…ˆå¡«å†™æ™ºèƒ½ç”Ÿæˆæç¤ºè¯');
                return;
            }

            const button = document.getElementById('generateActions');
            const originalText = button.textContent;
            button.textContent = 'ğŸ¤– æ­£åœ¨ç”Ÿæˆ...';
            button.disabled = true;

            try {
                const response = await fetch('/admin/api/generate-actions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        category,
                        name,
                        display_name,
                        description,
                        prompt
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const actionsJson = JSON.stringify(result.actions, null, 2);
                    if (createActionsEditor) {
                        createActionsEditor.setValue(actionsJson);
                    } else {
                        document.getElementById('createActions').value = actionsJson;
                    }

                    if (result.note) {
                        alert('åŠ¨ä½œå®šä¹‰å·²ç”Ÿæˆï¼\n\næç¤ºï¼š' + result.note);
                    } else {
                        alert('åŠ¨ä½œå®šä¹‰å·²ç”ŸæˆæˆåŠŸï¼è¯·æ£€æŸ¥å¹¶æ ¹æ®éœ€è¦è°ƒæ•´ã€‚');
                    }
                } else {
                    alert('ç”Ÿæˆå¤±è´¥ï¼š' + result.error);
                }
            } catch (error) {
                console.error('Generation failed:', error);
                alert('ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        });

        document.getElementById('createAppForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                // ä»Monaco Editoræˆ–textareaè·å–actionså†…å®¹
                let actionsText;
                if (createActionsEditor) {
                    actionsText = createActionsEditor.getValue();
                } else {
                    actionsText = formData.get('actions');
                }

                const actions = JSON.parse(actionsText || '[]');
                const response = await fetch('/admin/api/apps', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        category: formData.get('category'),
                        name: formData.get('name'),
                        display_name: formData.get('display_name'),
                        description: formData.get('description'),
                        template: {actions}
                    })
                });

                if (response.ok) {
                    hideModal();
                    loadApps();
                    alert('åº”ç”¨åˆ›å»ºæˆåŠŸ');
                    // é‡ç½®è¡¨å•
                    document.getElementById('createAppForm').reset();
                    document.getElementById('createPrompt').value = '';
                    if (createActionsEditor) {
                        createActionsEditor.setValue('[\n  {\n    "name": "example_action",\n    "display_name": "ç¤ºä¾‹åŠ¨ä½œ",\n    "description": "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹åŠ¨ä½œ",\n    "parameters": [\n      {\n        "key": "input",\n        "type": "String",\n        "required": true,\n        "description": "è¾“å…¥å‚æ•°"\n      }\n    ]\n  }\n]');
                    }
                } else {
                    alert('åˆ›å»ºå¤±è´¥ï¼š' + (await response.text()));
                }
            } catch (error) {
                alert('JSONæ ¼å¼é”™è¯¯ï¼š' + error.message);
            }
        });

        document.getElementById('editAppForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const appId = document.getElementById('editAppId').value;

            try {
                const actions = JSON.parse(formData.get('actions') || '[]');
                const response = await fetch(`/admin/api/apps/${appId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        category: formData.get('category'),
                        name: formData.get('name'),
                        display_name: formData.get('display_name'),
                        description: formData.get('description'),
                        template: {actions}
                    })
                });

                if (response.ok) {
                    hideEditModal();
                    loadApps();
                    alert('åº”ç”¨æ›´æ–°æˆåŠŸ');
                } else {
                    alert('æ›´æ–°å¤±è´¥ï¼š' + (await response.text()));
                }
            } catch (error) {
                alert('JSONæ ¼å¼é”™è¯¯');
            }
        });

        async function toggleApp(id, enabled) {
            await fetch(`/admin/api/apps/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled})
            });
            loadApps();
        }

        async function deleteApp(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤åº”ç”¨ï¼Ÿ')) return;
            await fetch(`/admin/api/apps/${id}`, {method: 'DELETE'});
            loadApps();
        }

        loadApps();
    </script>

{% include '_footer.html' %}
</body>
</html>