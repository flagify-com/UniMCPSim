<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº”ç”¨ç®¡ç† - UniMCPSim</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <!-- Monaco Editor Local -->
    <script src="/static/js/monaco-editor/vs/loader.js"></script>
</head>
<body>
{% include '_navigation.html' %}

    <div class="container mt-3">
        <div class="card card-action-bar">
            <div class="d-flex justify-between align-center">
                <h2 class="card-header">åº”ç”¨åˆ—è¡¨</h2>
                <div class="d-flex gap-2">
                    <button onclick="showExportModal()" class="btn btn-secondary btn-sm">ğŸ“¤ å¯¼å‡º</button>
                    <button onclick="showImportModal()" class="btn btn-secondary btn-sm">ğŸ“¥ å¯¼å…¥</button>
                    <button onclick="showCreateModal()" class="btn btn-primary btn-sm">åˆ›å»ºæ–°åº”ç”¨</button>
                </div>
            </div>
        </div>

        <div class="card">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ç±»åˆ«</th>
                        <th>åç§°</th>
                        <th>æ˜¾ç¤ºåç§°</th>
                        <th>è·¯å¾„</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="appsList">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- åˆ›å»ºåº”ç”¨æ¨¡æ€æ¡† -->
    <div id="createModal" class="modal">
        <div class="modal-content extra-large">
            <div class="modal-header">
                <h3 class="modal-title">åˆ›å»ºæ–°åº”ç”¨</h3>
                <div class="modal-header-actions">
                    <button type="submit" form="createAppForm" id="createSubmitBtn" class="btn btn-primary">åˆ›å»º</button>
                    <button type="button" onclick="hideModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </div>
            <form id="createAppForm">
                <div class="modal-three-columns">
                    <!-- å·¦åˆ—ï¼šåŸºæœ¬ä¿¡æ¯ (25%) -->
                    <div class="modal-column-left">
                        <h4 style="color: var(--primary-100); margin-bottom: 1rem;">1. åŸºæœ¬ä¿¡æ¯</h4>

                        <div class="form-group">
                            <label class="form-label">ç±»åˆ«</label>
                            <input type="text" name="category" class="form-control" required value="SOAR">
                        </div>
                        <div class="form-group">
                            <label class="form-label">åç§°</label>
                            <input type="text" name="name" class="form-control" required value="HoneyGuide-SOAR">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ˜¾ç¤ºåç§°</label>
                            <input type="text" name="display_name" class="form-control" required value="é›¾å¸œæ™ºèƒ½HoneyGuide SOAR">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea name="description" class="form-control" rows="3">é›¾å¸œæ™ºèƒ½ç¼–æ’è‡ªåŠ¨åŒ–äº§å“HoneyGuideï¼Œæ”¯æŒå®‰å…¨å‰§æœ¬playbookçš„æŸ¥è¯¢å’Œä½¿ç”¨ã€‚</textarea>
                        </div>
                    </div>

                    <!-- ä¸­åˆ—ï¼šAIæ™ºèƒ½ç”Ÿæˆé…ç½® (30%) -->
                    <div class="modal-column-center">
                        <h4 style="color: var(--primary-100); margin-bottom: 1rem;">2. AIæ™ºèƒ½ç”Ÿæˆé…ç½®</h4>

                        <div class="form-group">
                            <label class="form-label">æ™ºèƒ½ç”Ÿæˆæç¤ºè¯</label>
                            <textarea id="createPrompt" class="form-control" rows="10">å·¥å…·1ï¼šæŸ¥è¯¢å¯ç”¨å‰§æœ¬åˆ—è¡¨
è¿”å›ï¼šå‰§æœ¬IDã€å‰§æœ¬åç§°

å·¥å…·2ï¼šæŸ¥è¯¢æŒ‡å®šå‰§æœ¬çš„è¯¦ç»†ä¿¡æ¯
è¾“å…¥å‚æ•°ï¼šå‰§æœ¬ID
è¿”å›ï¼šå‰§æœ¬IDã€å‰§æœ¬åç§°ã€å‚æ•°åˆ—è¡¨ï¼ˆæ¯ä¸ªå‚æ•°åŒ…å«ï¼šå‚æ•°åã€ç±»å‹ã€æ˜¯å¦å¿…å¡«ã€é»˜è®¤å€¼ï¼‰

å·¥å…·3ï¼šæ‰§è¡Œå‰§æœ¬
è¾“å…¥å‚æ•°ï¼šå‰§æœ¬IDã€å‰§æœ¬å‚æ•°ï¼ˆJSONå¯¹è±¡ï¼‰
è¿”å›ï¼šå‰§æœ¬æ‰§è¡Œä»»åŠ¡ID

å·¥å…·4ï¼šè·å–å‰§æœ¬æ‰§è¡Œç»“æœ
è¾“å…¥å‚æ•°ï¼šå‰§æœ¬æ‰§è¡Œä»»åŠ¡ID
è¿”å›ï¼šæ‰§è¡ŒçŠ¶æ€ã€æ‰§è¡Œç»“æœã€å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´</textarea>
                        </div>

                        <button type="button" id="generateActions" class="btn btn-secondary btn-block" style="margin-bottom: 1.5rem;" disabled>
                            3. ğŸ¤– è‡ªåŠ¨ç”ŸæˆåŠ¨ä½œå®šä¹‰
                        </button>

                        <div class="form-group">
                            <label class="form-label">å¯¹AIæ¨¡æ‹Ÿç»“æœçš„å…¶ä»–è¦æ±‚/å‚è€ƒä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</label>
                            <textarea name="ai_notes" class="form-control" rows="10" placeholder="å¯¹æ¨¡æ‹Ÿå“åº”çš„æ ¼å¼ã€é£æ ¼ã€æ•°æ®æ ·ä¾‹ç­‰è¦æ±‚ï¼Œå¸®åŠ©AIç”Ÿæˆæ›´ç¬¦åˆé¢„æœŸçš„ç»“æœ

ç¤ºä¾‹ï¼š
- æ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨ISO 8601æ ¼å¼ï¼ˆå¦‚ï¼š2024-01-15T10:30:00Zï¼‰
- é”™è¯¯å“åº”åŒ…å«error_codeå’Œerror_messageå­—æ®µ
- æˆåŠŸå“åº”æ ¼å¼ï¼š{&quot;status&quot;: &quot;success&quot;, &quot;data&quot;: {...}, &quot;timestamp&quot;: &quot;...&quot;}
- IPåœ°å€å­—æ®µéœ€åŒ…å«åœ°ç†ä½ç½®ä¿¡æ¯ï¼ˆå›½å®¶ã€åŸå¸‚ï¼‰"></textarea>
                        </div>
                    </div>

                    <!-- å³åˆ—ï¼šJSONç¼–è¾‘å™¨ (45%) -->
                    <div class="modal-column-right">
                        <h4 style="color: var(--primary-100); margin-bottom: 1rem;">4. JSONæ ¼å¼åŠ¨ä½œé…ç½®</h4>
                        <div id="createActionsEditor" class="monaco-editor-container-large" style="height: 100%; min-height: 600px;"></div>
                        <textarea id="createActions" name="actions" style="display: none;"></textarea>
                    </div>
                </div>
                <!-- åº•éƒ¨å®‰å…¨å«ï¼šé˜²æ­¢å†…å®¹è´´åˆ°å¼¹çª—åº•éƒ¨è¾¹ç•Œ -->
                <div class="modal-bottom-spacer"></div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘åº”ç”¨æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content large">
            <h3 class="modal-title">ç¼–è¾‘åº”ç”¨</h3>
            <form id="editAppForm">
                <input type="hidden" id="editAppId">
                <div class="modal-split">
                    <!-- å·¦ä¾§ï¼šåŸºæœ¬ä¿¡æ¯ -->
                    <div>
                        <h4 style="color: var(--primary-100); margin-bottom: 1rem;">åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="form-group">
                            <label class="form-label">ç±»åˆ«</label>
                            <input type="text" id="editCategory" name="category" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">åç§°</label>
                            <input type="text" id="editName" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ˜¾ç¤ºåç§°</label>
                            <input type="text" id="editDisplayName" name="display_name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea id="editDescription" name="description" class="form-control" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¯¹AIæ¨¡æ‹Ÿç»“æœçš„å…¶ä»–è¦æ±‚/å‚è€ƒä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</label>
                            <textarea id="editAiNotes" name="ai_notes" class="form-control" rows="6" placeholder="å¯¹æ¨¡æ‹Ÿå“åº”çš„æ ¼å¼ã€é£æ ¼ã€æ•°æ®æ ·ä¾‹ç­‰è¦æ±‚ï¼Œå¸®åŠ©AIç”Ÿæˆæ›´ç¬¦åˆé¢„æœŸçš„ç»“æœ"></textarea>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šåŠ¨ä½œå®šä¹‰ -->
                    <div>
                        <h4 style="color: var(--primary-100); margin-bottom: 1rem;">åŠ¨ä½œå®šä¹‰</h4>
                        <div class="form-group">
                            <label class="form-label">JSONæ ¼å¼åŠ¨ä½œé…ç½®</label>
                            <div id="editActionsEditor" class="monaco-editor-container"></div>
                            <textarea id="editActions" name="actions" style="display: none;"></textarea>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--bg-300);">
                    <button type="submit" class="btn btn-primary">æ›´æ–°åº”ç”¨</button>
                    <button type="button" onclick="hideEditModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åº”ç”¨è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailsModal" class="modal">
        <div class="modal-content large">
            <h3 class="modal-title" id="detailsTitle">åº”ç”¨è¯¦æƒ…</h3>
            <div style="max-height: 600px; overflow-y: auto;">
                <div class="card" style="background-color: var(--bg-200); margin-bottom: 1rem;">
                    <h4 style="color: var(--primary-100); margin-bottom: 0.5rem;">åŸºæœ¬ä¿¡æ¯</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div>
                            <strong>ID:</strong> <span id="detailId"></span>
                        </div>
                        <div>
                            <strong>ç±»åˆ«:</strong> <span id="detailCategory"></span>
                        </div>
                        <div>
                            <strong>åç§°:</strong> <code id="detailName"></code>
                        </div>
                        <div>
                            <strong>æ˜¾ç¤ºåç§°:</strong> <span id="detailDisplayName"></span>
                        </div>
                        <div>
                            <strong>è·¯å¾„:</strong> <code id="detailPath"></code>
                        </div>
                        <div>
                            <strong>çŠ¶æ€:</strong> <span id="detailStatus"></span>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>æè¿°:</strong>
                        <div id="detailDescription" style="margin-top: 0.5rem; padding: 0.5rem; background-color: var(--bg-100); border-radius: 4px;"></div>
                    </div>
                </div>

                <div class="card">
                    <h4 style="color: var(--primary-100); margin-bottom: 0.5rem;">åŠ¨ä½œåˆ—è¡¨</h4>
                    <div id="detailActions"></div>
                </div>
            </div>

            <div style="margin-top: 1rem;">
                <button onclick="hideDetailsModal()" class="btn btn-secondary">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- MCPé…ç½®æ¨¡æ€æ¡† -->
    <div id="mcpConfigModal" class="modal">
        <div class="modal-content medium">
            <h3 class="modal-title">MCPå®¢æˆ·ç«¯é…ç½®</h3>
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                å¤åˆ¶ä»¥ä¸‹é…ç½®åˆ°Cherry Studioã€Claude Desktopæˆ–Clineçš„MCPé…ç½®æ–‡ä»¶ä¸­ã€‚<br>
                <strong>æ³¨æ„ï¼š</strong>éœ€è¦ä»Tokenç®¡ç†é¡µé¢è·å–æœ‰æ•ˆçš„tokenå¡«å…¥baseUrlå‚æ•°ã€‚
            </div>
            <div class="form-group">
                <label class="form-label">é…ç½®å†…å®¹</label>
                <textarea id="mcpConfigText" class="form-control" rows="15" readonly style="font-family: monospace; font-size: 13px;"></textarea>
            </div>
            <div class="d-flex gap-2">
                <button onclick="copyMcpConfig()" class="btn btn-primary">ğŸ“‹ å¤åˆ¶é…ç½®</button>
                <button onclick="hideMcpConfigModal()" class="btn btn-secondary">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
    <div id="exportModal" class="modal">
        <div class="modal-content medium">
            <h3 class="modal-title">å¯¼å‡ºåº”ç”¨é…ç½®</h3>
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                é€‰æ‹©è¦å¯¼å‡ºçš„åº”ç”¨ï¼Œæˆ–ç›´æ¥ç‚¹å‡»"å¯¼å‡ºå…¨éƒ¨"å¯¼å‡ºæ‰€æœ‰åº”ç”¨é…ç½®ã€‚
            </div>
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600;">å·²é€‰æ‹© <span id="exportSelectedCount">0</span> ä¸ªåº”ç”¨</span>
                    <div>
                        <button onclick="selectAllExport()" class="btn btn-sm btn-secondary">å…¨é€‰</button>
                        <button onclick="deselectAllExport()" class="btn btn-sm btn-secondary">å–æ¶ˆå…¨é€‰</button>
                    </div>
                </div>
                <div id="exportAppsList" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--bg-300); border-radius: 4px; padding: 0.5rem;">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            <div class="d-flex gap-2">
                <button onclick="exportSelected()" id="exportSelectedBtn" class="btn btn-primary" disabled>å¯¼å‡ºé€‰ä¸­</button>
                <button onclick="exportAll()" class="btn btn-secondary">å¯¼å‡ºå…¨éƒ¨</button>
                <button onclick="hideExportModal()" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="importModal" class="modal">
        <div class="modal-content medium">
            <h3 class="modal-title">å¯¼å…¥åº”ç”¨é…ç½®</h3>
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                é€‰æ‹©JSONæ ¼å¼çš„åº”ç”¨é…ç½®æ–‡ä»¶ã€‚å¯¼å…¥æ—¶ä¼šè‡ªåŠ¨è¦†ç›–åŒååº”ç”¨ï¼ˆæŒ‰ç±»åˆ«+åç§°åŒ¹é…ï¼‰ã€‚
            </div>
            <div class="form-group">
                <label class="form-label">é€‰æ‹©æ–‡ä»¶</label>
                <input type="file" id="importFile" accept=".json" class="form-control" onchange="handleFileSelect(event)">
            </div>
            <div class="d-flex gap-2">
                <button onclick="startImport()" id="importBtn" class="btn btn-primary" disabled>å¼€å§‹å¯¼å…¥</button>
                <button onclick="hideImportModal()" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="importPreviewModal" class="modal">
        <div class="modal-content large">
            <h3 class="modal-title">å¯¼å…¥é¢„è§ˆ</h3>
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                ä»¥ä¸‹åº”ç”¨å°†è¢«å¯¼å…¥ã€‚åŒååº”ç”¨å°†è¢«è¦†ç›–ï¼Œè¯·ä»”ç»†ç¡®è®¤ã€‚
            </div>

            <div id="importPreviewContent">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>

            <div class="d-flex gap-2" style="margin-top: 1.5rem;">
                <button onclick="confirmImport()" class="btn btn-primary">ç¡®è®¤å¯¼å…¥</button>
                <button onclick="hideImportPreviewModal()" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let editActionsEditor = null;
        let createActionsEditor = null;

        // éªŒè¯åº”ç”¨åç§°/ç±»åˆ«
        function validateAppName(name, fieldName) {
            if (!name || name.trim() === '') {
                return { valid: false, error: `${fieldName}ä¸èƒ½ä¸ºç©º` };
            }

            // åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦
            const regex = /^[a-zA-Z0-9_-]+$/;
            if (!regex.test(name)) {
                return { valid: false, error: `${fieldName}åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦` };
            }

            // é•¿åº¦é™åˆ¶
            if (name.length < 2 || name.length > 50) {
                return { valid: false, error: `${fieldName}é•¿åº¦å¿…é¡»åœ¨2-50ä¸ªå­—ç¬¦ä¹‹é—´` };
            }

            return { valid: true, error: '' };
        }

        // æ˜¾ç¤ºé€šçŸ¥æç¤º
        function showNotification(message, type = 'info') {
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };

            const notification = document.createElement('div');
            notification.className = `notification-toast ${type}`;
            notification.innerHTML = `
                <span class="notification-icon">${icons[type] || icons.info}</span>
                <div class="notification-content">${message}</div>
                <button class="notification-close" onclick="this.parentElement.remove()">âœ•</button>
            `;

            document.body.appendChild(notification);

            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // åˆå§‹åŒ–Monaco Editor
        require.config({ paths: { vs: '/static/js/monaco-editor/vs' } });
        require(['vs/editor/editor.main'], function () {
            // ç¼–è¾‘æ¨¡æ€æ¡†çš„Monaco Editor
            editActionsEditor = monaco.editor.create(document.getElementById('editActionsEditor'), {
                value: '[\n  {\n    "name": "action_name",\n    "display_name": "åŠ¨ä½œæ˜¾ç¤ºå",\n    "description": "åŠ¨ä½œæè¿°",\n    "parameters": [\n      {\n        "key": "param_name",\n        "type": "String",\n        "required": true,\n        "description": "å‚æ•°æè¿°"\n      }\n    ]\n  }\n]',
                language: 'json',
                theme: 'vs-dark',
                fontSize: 14,
                lineNumbers: 'on',
                minimap: { enabled: false },
                automaticLayout: true,
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                formatOnType: true,
                formatOnPaste: true,
                tabSize: 2,
                insertSpaces: true
            });

            // ç›‘å¬ç¼–è¾‘å™¨å†…å®¹å˜åŒ–ï¼ŒåŒæ­¥åˆ°éšè—çš„textarea
            editActionsEditor.onDidChangeModelContent(() => {
                const textarea = document.getElementById('editActions');
                textarea.value = editActionsEditor.getValue();
            });

            // åˆ›å»ºæ¨¡æ€æ¡†çš„Monaco Editor
            createActionsEditor = monaco.editor.create(document.getElementById('createActionsEditor'), {
                value: '[\n  {\n    "name": "example_action",\n    "display_name": "ç¤ºä¾‹åŠ¨ä½œ",\n    "description": "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹åŠ¨ä½œ",\n    "parameters": [\n      {\n        "key": "input",\n        "type": "String",\n        "required": true,\n        "description": "è¾“å…¥å‚æ•°"\n      }\n    ]\n  }\n]',
                language: 'json',
                theme: 'vs-dark',
                fontSize: 14,
                lineNumbers: 'on',
                minimap: { enabled: false },
                automaticLayout: true,
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                formatOnType: true,
                formatOnPaste: true,
                tabSize: 2,
                insertSpaces: true
            });

            // ç›‘å¬åˆ›å»ºç¼–è¾‘å™¨å†…å®¹å˜åŒ–ï¼ŒåŒæ­¥åˆ°éšè—çš„textarea
            createActionsEditor.onDidChangeModelContent(() => {
                const textarea = document.getElementById('createActions');
                textarea.value = createActionsEditor.getValue();
            });

            // ç›‘å¬æç¤ºè¯è¾“å…¥æ¡†å˜åŒ–ï¼Œæ§åˆ¶AIç”ŸæˆæŒ‰é’®çŠ¶æ€
            document.getElementById('createPrompt').addEventListener('input', (e) => {
                const generateBtn = document.getElementById('generateActions');
                const hasContent = e.target.value.trim().length > 0;
                generateBtn.disabled = !hasContent;

                // å¦‚æœæœ‰å†…å®¹ï¼Œå˜æˆè“è‰²æŒ‰é’®
                if (hasContent) {
                    generateBtn.classList.remove('btn-secondary');
                    generateBtn.classList.add('btn-primary');
                } else {
                    generateBtn.classList.remove('btn-primary');
                    generateBtn.classList.add('btn-secondary');
                }
            });
        });

        // å…¨å±€åº”ç”¨æ•°æ®ç¼“å­˜
        let allApps = [];

        async function loadApps() {
            try {
                const response = await fetch('/admin/api/apps');
                allApps = await response.json();
                const tbody = document.getElementById('appsList');

                tbody.innerHTML = allApps.map(app => `
                    <tr>
                        <td>${app.id}</td>
                        <td>${app.category}</td>
                        <td><a href="javascript:void(0)" onclick="showAppDetails(${app.id})" style="color: var(--primary-100); text-decoration: none;">${app.name}</a></td>
                        <td>${app.display_name}</td>
                        <td>/${app.category}/${app.name}</td>
                        <td>
                            <span class="badge ${app.enabled ? 'badge-success' : 'badge-danger'}">
                                ${app.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                            </span>
                        </td>
                        <td>
                            <button onclick="showMcpConfig(${app.id})" class="btn btn-sm btn-primary">MCPé…ç½®</button>
                            <button onclick="editApp(${app.id})" class="btn btn-sm btn-secondary">ç¼–è¾‘</button>
                            <button onclick="toggleApp(${app.id}, ${!app.enabled})" class="btn btn-sm btn-secondary">
                                ${app.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button onclick="deleteApp(${app.id})" class="btn btn-sm btn-danger">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load apps:', error);
            }
        }

        // é»˜è®¤å€¼å¸¸é‡
        const DEFAULT_CATEGORY = 'SOAR';
        const DEFAULT_NAME = 'HoneyGuide-SOAR';
        const DEFAULT_DISPLAY_NAME = 'é›¾å¸œæ™ºèƒ½HoneyGuide SOAR';
        const DEFAULT_DESCRIPTION = 'é›¾å¸œæ™ºèƒ½ç¼–æ’è‡ªåŠ¨åŒ–äº§å“HoneyGuideï¼Œæ”¯æŒå®‰å…¨å‰§æœ¬playbookçš„æŸ¥è¯¢å’Œä½¿ç”¨ã€‚';
        const DEFAULT_PROMPT = `å·¥å…·1ï¼šæŸ¥è¯¢å¯ç”¨å‰§æœ¬åˆ—è¡¨
è¿”å›ï¼šå‰§æœ¬IDã€å‰§æœ¬åç§°

å·¥å…·2ï¼šæŸ¥è¯¢æŒ‡å®šå‰§æœ¬çš„è¯¦ç»†ä¿¡æ¯
è¾“å…¥å‚æ•°ï¼šå‰§æœ¬ID
è¿”å›ï¼šå‰§æœ¬IDã€å‰§æœ¬åç§°ã€å‚æ•°åˆ—è¡¨ï¼ˆæ¯ä¸ªå‚æ•°åŒ…å«ï¼šå‚æ•°åã€ç±»å‹ã€æ˜¯å¦å¿…å¡«ã€é»˜è®¤å€¼ï¼‰

å·¥å…·3ï¼šæ‰§è¡Œå‰§æœ¬
è¾“å…¥å‚æ•°ï¼šå‰§æœ¬IDã€å‰§æœ¬å‚æ•°ï¼ˆJSONå¯¹è±¡ï¼‰
è¿”å›ï¼šå‰§æœ¬æ‰§è¡Œä»»åŠ¡ID

å·¥å…·4ï¼šè·å–å‰§æœ¬æ‰§è¡Œç»“æœ
è¾“å…¥å‚æ•°ï¼šå‰§æœ¬æ‰§è¡Œä»»åŠ¡ID
è¿”å›ï¼šæ‰§è¡ŒçŠ¶æ€ã€æ‰§è¡Œç»“æœã€å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´`;
        const DEFAULT_ACTIONS = `[
  {
    "name": "example_action",
    "display_name": "ç¤ºä¾‹åŠ¨ä½œ",
    "description": "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹åŠ¨ä½œ",
    "parameters": [
      {
        "key": "input",
        "type": "String",
        "required": true,
        "description": "è¾“å…¥å‚æ•°"
      }
    ]
  }
]`;

        // é‡ç½®åˆ›å»ºè¡¨å•ä¸ºé»˜è®¤å€¼
        function resetCreateForm() {
            document.querySelector('#createAppForm input[name="category"]').value = DEFAULT_CATEGORY;
            document.querySelector('#createAppForm input[name="name"]').value = DEFAULT_NAME;
            document.querySelector('#createAppForm input[name="display_name"]').value = DEFAULT_DISPLAY_NAME;
            document.querySelector('#createAppForm textarea[name="description"]').value = DEFAULT_DESCRIPTION;
            document.getElementById('createPrompt').value = DEFAULT_PROMPT;
            document.querySelector('#createAppForm textarea[name="ai_notes"]').value = '';

            if (createActionsEditor) {
                createActionsEditor.setValue(DEFAULT_ACTIONS);
            }

            // ç”±äºæœ‰é»˜è®¤æç¤ºè¯ï¼Œä¿æŒAIç”ŸæˆæŒ‰é’®ä¸ºå¯ç”¨çŠ¶æ€
            const generateBtn = document.getElementById('generateActions');
            generateBtn.disabled = false;
            generateBtn.classList.remove('btn-secondary');
            generateBtn.classList.add('btn-primary');
        }

        function showCreateModal() {
            document.getElementById('createModal').classList.add('show');

            // æ£€æŸ¥æç¤ºè¯æ˜¯å¦æœ‰å†…å®¹ï¼Œå¦‚æœæœ‰åˆ™å¯ç”¨AIç”ŸæˆæŒ‰é’®
            const promptTextarea = document.getElementById('createPrompt');
            const generateBtn = document.getElementById('generateActions');
            const hasContent = promptTextarea.value.trim().length > 0;

            if (hasContent) {
                generateBtn.disabled = false;
                generateBtn.classList.remove('btn-secondary');
                generateBtn.classList.add('btn-primary');
            } else {
                generateBtn.disabled = true;
                generateBtn.classList.remove('btn-primary');
                generateBtn.classList.add('btn-secondary');
            }
        }

        function hideModal() {
            document.getElementById('createModal').classList.remove('show');
        }

        function hideEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function editApp(id) {
            try {
                const response = await fetch(`/admin/api/apps/${id}`);
                const app = await response.json();

                document.getElementById('editAppId').value = app.id;
                document.getElementById('editCategory').value = app.category;
                document.getElementById('editName').value = app.name;
                document.getElementById('editDisplayName').value = app.display_name;
                document.getElementById('editDescription').value = app.description || '';
                document.getElementById('editAiNotes').value = app.ai_notes || '';

                // è®¾ç½®Monaco Editorçš„å†…å®¹
                const actionsJson = JSON.stringify(app.template?.actions || [], null, 2);
                if (editActionsEditor) {
                    editActionsEditor.setValue(actionsJson);
                } else {
                    // å¦‚æœMonaco Editorè¿˜æ²¡åˆå§‹åŒ–ï¼Œè®¾ç½®åˆ°textareaä½œä¸ºåå¤‡
                    document.getElementById('editActions').value = actionsJson;
                }

                document.getElementById('editModal').classList.add('show');
            } catch (error) {
                console.error('Failed to load app details:', error);
                alert('åŠ è½½åº”ç”¨è¯¦æƒ…å¤±è´¥');
            }
        }

        // AIç”ŸæˆåŠ¨ä½œå®šä¹‰
        document.getElementById('generateActions').addEventListener('click', async () => {
            const category = document.querySelector('#createAppForm input[name="category"]').value;
            const name = document.querySelector('#createAppForm input[name="name"]').value;
            const display_name = document.querySelector('#createAppForm input[name="display_name"]').value;
            const description = document.querySelector('#createAppForm textarea[name="description"]').value;
            const prompt = document.getElementById('createPrompt').value;

            if (!prompt.trim()) {
                showNotification('è¯·å…ˆå¡«å†™æ™ºèƒ½ç”Ÿæˆæç¤ºè¯', 'error');
                return;
            }

            const button = document.getElementById('generateActions');
            const originalText = button.textContent;
            button.textContent = 'ğŸ¤– æ­£åœ¨ç”Ÿæˆ...';
            button.disabled = true;

            try {
                const response = await fetch('/admin/api/generate-actions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        category,
                        name,
                        display_name,
                        description,
                        prompt
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const actionsJson = JSON.stringify(result.actions, null, 2);
                    if (createActionsEditor) {
                        createActionsEditor.setValue(actionsJson);
                    } else {
                        document.getElementById('createActions').value = actionsJson;
                    }

                    if (result.note) {
                        showNotification('åŠ¨ä½œå®šä¹‰å·²ç”Ÿæˆï¼\n\næç¤ºï¼š' + result.note, 'success');
                    } else {
                        showNotification('âœ… åŠ¨ä½œå®šä¹‰å·²ç”ŸæˆæˆåŠŸï¼è¯·æ£€æŸ¥å¹¶æ ¹æ®éœ€è¦è°ƒæ•´ã€‚', 'success');
                    }

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.textContent = originalText;
                    button.disabled = false;  // ä¿æŒæŒ‰é’®å¯ç”¨çŠ¶æ€ï¼Œå› ä¸ºæç¤ºè¯è¿˜åœ¨
                } else {
                    showNotification('ç”Ÿæˆå¤±è´¥ï¼š' + result.error, 'error');
                    // å¤±è´¥æ—¶ä¹Ÿæ¢å¤æŒ‰é’®
                    button.textContent = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                console.error('Generation failed:', error);
                showNotification('ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                // å‡ºé”™æ—¶æ¢å¤æŒ‰é’®
                button.textContent = originalText;
                button.disabled = false;
            }
        });

        document.getElementById('createAppForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            // å‰ç«¯éªŒè¯ç±»åˆ«å’Œåç§°
            const category = formData.get('category');
            const name = formData.get('name');

            const categoryValidation = validateAppName(category, 'ç±»åˆ«');
            if (!categoryValidation.valid) {
                showNotification(categoryValidation.error, 'error');
                return;
            }

            const nameValidation = validateAppName(name, 'åç§°');
            if (!nameValidation.valid) {
                showNotification(nameValidation.error, 'error');
                return;
            }

            try {
                // ä»Monaco Editoræˆ–textareaè·å–actionså†…å®¹
                let actionsText;
                if (createActionsEditor) {
                    actionsText = createActionsEditor.getValue();
                } else {
                    actionsText = formData.get('actions');
                }

                const actions = JSON.parse(actionsText || '[]');
                const response = await fetch('/admin/api/apps', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        category: category,
                        name: name,
                        display_name: formData.get('display_name'),
                        description: formData.get('description'),
                        ai_notes: formData.get('ai_notes') || '',
                        template: {actions}
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    hideModal();
                    loadApps();
                    // æ˜¾ç¤ºåç«¯è¿”å›çš„æç¤ºæ¶ˆæ¯
                    showNotification(result.message || 'åº”ç”¨åˆ›å»ºæˆåŠŸ', 'success');
                    // é‡ç½®è¡¨å•ä¸ºé»˜è®¤å€¼
                    resetCreateForm();
                } else {
                    const errorData = await response.json();
                    showNotification('åˆ›å»ºå¤±è´¥ï¼š' + (errorData.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showNotification('JSONæ ¼å¼é”™è¯¯ï¼š' + error.message, 'error');
            }
        });

        document.getElementById('editAppForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const appId = document.getElementById('editAppId').value;

            // å‰ç«¯éªŒè¯ç±»åˆ«å’Œåç§°
            const category = formData.get('category');
            const name = formData.get('name');

            const categoryValidation = validateAppName(category, 'ç±»åˆ«');
            if (!categoryValidation.valid) {
                showNotification(categoryValidation.error, 'error');
                return;
            }

            const nameValidation = validateAppName(name, 'åç§°');
            if (!nameValidation.valid) {
                showNotification(nameValidation.error, 'error');
                return;
            }

            try {
                const actions = JSON.parse(formData.get('actions') || '[]');
                const response = await fetch(`/admin/api/apps/${appId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        category: category,
                        name: name,
                        display_name: formData.get('display_name'),
                        description: formData.get('description'),
                        ai_notes: formData.get('ai_notes') || '',
                        template: {actions}
                    })
                });

                if (response.ok) {
                    hideEditModal();
                    loadApps();
                    showNotification('åº”ç”¨æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    const errorData = await response.json();
                    showNotification('æ›´æ–°å¤±è´¥ï¼š' + (errorData.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showNotification('JSONæ ¼å¼é”™è¯¯ï¼š' + error.message, 'error');
            }
        });

        async function toggleApp(id, enabled) {
            await fetch(`/admin/api/apps/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled})
            });
            loadApps();
        }

        async function deleteApp(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤åº”ç”¨ï¼Ÿ')) return;
            await fetch(`/admin/api/apps/${id}`, {method: 'DELETE'});
            loadApps();
        }

        async function showAppDetails(id) {
            try {
                const response = await fetch(`/admin/api/apps/${id}`);
                const app = await response.json();

                document.getElementById('detailsTitle').textContent = `${app.display_name} - åº”ç”¨è¯¦æƒ…`;
                document.getElementById('detailId').textContent = app.id;
                document.getElementById('detailCategory').textContent = app.category;
                document.getElementById('detailName').textContent = app.name;
                document.getElementById('detailDisplayName').textContent = app.display_name;
                document.getElementById('detailPath').textContent = `/${app.category}/${app.name}`;
                document.getElementById('detailStatus').innerHTML = `<span class="badge ${app.enabled ? 'badge-success' : 'badge-danger'}">${app.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>`;
                document.getElementById('detailDescription').textContent = app.description || 'æ— æè¿°';

                // æ¸²æŸ“åŠ¨ä½œåˆ—è¡¨
                const actions = app.template?.actions || [];
                const actionsHtml = actions.length > 0 ? actions.map(action => `
                    <div class="card" style="margin-bottom: 1rem; background-color: var(--bg-100);">
                        <h5 style="color: var(--primary-100);">${action.display_name || action.name}</h5>
                        <p style="margin: 0.5rem 0;"><strong>åŠ¨ä½œå:</strong> <code>${action.name}</code></p>
                        <p style="margin: 0.5rem 0;"><strong>æè¿°:</strong> ${action.description || 'æ— æè¿°'}</p>
                        ${action.parameters && action.parameters.length > 0 ? `
                            <p style="margin: 0.5rem 0;"><strong>å‚æ•°:</strong></p>
                            <ul style="margin: 0; padding-left: 1.5rem;">
                                ${action.parameters.map(param => `
                                    <li>
                                        <code>${param.key}</code> (${param.type})
                                        ${param.required ? '<span class="badge badge-danger" style="font-size: 0.75rem;">å¿…å¡«</span>' : ''}
                                        - ${param.description || 'æ— æè¿°'}
                                    </li>
                                `).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `).join('') : '<p style="color: var(--text-secondary);">æš‚æ— åŠ¨ä½œå®šä¹‰</p>';

                document.getElementById('detailActions').innerHTML = actionsHtml;
                document.getElementById('detailsModal').classList.add('show');
            } catch (error) {
                console.error('Failed to load app details:', error);
                alert('åŠ è½½åº”ç”¨è¯¦æƒ…å¤±è´¥');
            }
        }

        function hideDetailsModal() {
            document.getElementById('detailsModal').classList.remove('show');
        }

        async function showMcpConfig(id) {
            try {
                const response = await fetch(`/admin/api/apps/${id}`);
                const app = await response.json();

                const config = {
                    "mcpServers": {
                        [app.name]: {
                            "name": app.display_name,
                            "type": "streamableHttp",
                            "description": app.description || app.display_name,
                            "isActive": true,
                            "baseUrl": `http://127.0.0.1:{{ mcp_port }}/${app.category}/${app.name}?token=YOUR_TOKEN_HERE`
                        }
                    }
                };

                document.getElementById('mcpConfigText').value = JSON.stringify(config, null, 2);
                document.getElementById('mcpConfigModal').classList.add('show');
            } catch (error) {
                console.error('Failed to generate MCP config:', error);
                alert('ç”ŸæˆMCPé…ç½®å¤±è´¥');
            }
        }

        function hideMcpConfigModal() {
            document.getElementById('mcpConfigModal').classList.remove('show');
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            textArea.style.top = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                return true;
            } catch (err) {
                console.error('Fallback copy failed:', err);
                return false;
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function copyMcpConfig() {
            const text = document.getElementById('mcpConfigText').value;
            const successMsg = 'MCPé…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·è®°å¾—æ›¿æ¢ YOUR_TOKEN_HERE ä¸ºå®é™…çš„tokenå€¼ï¼ˆä»Tokenç®¡ç†é¡µé¢è·å–ï¼‰';

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert(successMsg);
                }).catch(err => {
                    console.error('Clipboard API failed:', err);
                    if (fallbackCopyToClipboard(text)) {
                        alert(successMsg);
                    } else {
                        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                    }
                });
            } else {
                if (fallbackCopyToClipboard(text)) {
                    alert(successMsg);
                } else {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                }
            }
        }

        // ========== å¯¼å‡ºåŠŸèƒ½ ==========
        function showExportModal() {
            // åŠ è½½åº”ç”¨åˆ—è¡¨åˆ°å¯¼å‡ºæ¨¡æ€æ¡†
            const container = document.getElementById('exportAppsList');
            container.innerHTML = allApps.map(app => `
                <div style="padding: 0.5rem; border-bottom: 1px solid var(--bg-300);">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="export-checkbox" value="${app.id}" onchange="updateExportCount()" style="margin-right: 0.5rem;">
                        <span><strong>${app.display_name}</strong> (${app.category}/${app.name})</span>
                    </label>
                </div>
            `).join('');

            updateExportCount();
            document.getElementById('exportModal').classList.add('show');
        }

        function hideExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        function updateExportCount() {
            const checkboxes = document.querySelectorAll('.export-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('exportSelectedCount').textContent = count;
            document.getElementById('exportSelectedBtn').disabled = count === 0;
        }

        function selectAllExport() {
            document.querySelectorAll('.export-checkbox').forEach(cb => cb.checked = true);
            updateExportCount();
        }

        function deselectAllExport() {
            document.querySelectorAll('.export-checkbox').forEach(cb => cb.checked = false);
            updateExportCount();
        }

        async function exportSelected() {
            const checkboxes = document.querySelectorAll('.export-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);

            if (ids.length === 0) {
                showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåº”ç”¨', 'error');
                return;
            }

            await performExport(ids);
        }

        async function exportAll() {
            await performExport([]);
        }

        async function performExport(ids) {
            try {
                const url = ids.length > 0
                    ? `/admin/api/apps/export?ids=${ids.join(',')}`
                    : '/admin/api/apps/export';

                const response = await fetch(url);
                const data = await response.json();

                // ç”Ÿæˆæ–‡ä»¶å
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `unimcp-apps-${timestamp}.json`;

                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);

                showNotification(`æˆåŠŸå¯¼å‡º ${data.count} ä¸ªåº”ç”¨é…ç½®`, 'success');
                hideExportModal();
            } catch (error) {
                console.error('Export failed:', error);
                showNotification('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========== å¯¼å…¥åŠŸèƒ½ ==========
        let importFileData = null;

        function showImportModal() {
            document.getElementById('importFile').value = '';
            document.getElementById('importBtn').disabled = true;
            importFileData = null;
            document.getElementById('importModal').classList.add('show');
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('importBtn').disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    importFileData = JSON.parse(e.target.result);

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!importFileData.applications || !Array.isArray(importFileData.applications)) {
                        throw new Error('æ— æ•ˆçš„æ–‡ä»¶æ ¼å¼ï¼šç¼ºå°‘applicationså­—æ®µ');
                    }

                    document.getElementById('importBtn').disabled = false;
                } catch (error) {
                    showNotification('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + error.message, 'error');
                    document.getElementById('importBtn').disabled = true;
                    importFileData = null;
                }
            };
            reader.readAsText(file);
        }

        async function startImport() {
            if (!importFileData) {
                showNotification('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            hideImportModal();

            // æ£€æŸ¥åŒååº”ç”¨
            const toImport = importFileData.applications;
            const newApps = [];
            const updateApps = [];

            for (const app of toImport) {
                const existing = allApps.find(a =>
                    a.category === app.category && a.name === app.name
                );
                if (existing) {
                    updateApps.push({ ...app, existingId: existing.id });
                } else {
                    newApps.push(app);
                }
            }

            // æ˜¾ç¤ºé¢„è§ˆ
            showImportPreview(newApps, updateApps);
        }

        function showImportPreview(newApps, updateApps) {
            const content = document.getElementById('importPreviewContent');

            let html = '';

            if (newApps.length > 0) {
                html += `
                    <div class="card" style="background-color: var(--bg-200); margin-bottom: 1rem;">
                        <h4 style="color: var(--primary-100); margin-bottom: 0.5rem;">âœ… æ–°å»ºåº”ç”¨ (${newApps.length}ä¸ª)</h4>
                        <ul style="margin: 0; padding-left: 1.5rem;">
                            ${newApps.map(app => `
                                <li><strong>${app.display_name}</strong> (${app.category}/${app.name})</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            if (updateApps.length > 0) {
                html += `
                    <div class="card" style="background-color: #fff3cd; margin-bottom: 1rem;">
                        <h4 style="color: #856404; margin-bottom: 0.5rem;">âš ï¸ è¦†ç›–ç°æœ‰åº”ç”¨ (${updateApps.length}ä¸ª)</h4>
                        <ul style="margin: 0; padding-left: 1.5rem; color: #856404;">
                            ${updateApps.map(app => `
                                <li><strong>${app.display_name}</strong> (${app.category}/${app.name}) - ID: ${app.existingId}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            html += `
                <div class="alert alert-info">
                    <strong>æ€»è®¡ï¼š</strong>${newApps.length + updateApps.length} ä¸ªåº”ç”¨
                    ï¼ˆæ–°å»º ${newApps.length} ä¸ªï¼Œè¦†ç›– ${updateApps.length} ä¸ªï¼‰
                </div>
            `;

            content.innerHTML = html;
            document.getElementById('importPreviewModal').classList.add('show');
        }

        function hideImportPreviewModal() {
            document.getElementById('importPreviewModal').classList.remove('show');
        }

        async function confirmImport() {
            try {
                const response = await fetch('/admin/api/apps/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(importFileData)
                });

                const result = await response.json();

                if (result.success) {
                    hideImportPreviewModal();
                    await loadApps();

                    // æ˜¾ç¤ºç»“æœ
                    const stats = result.results;
                    let message = `å¯¼å…¥å®Œæˆï¼\n\n`;
                    message += `âœ… æ–°å»ºï¼š${stats.created} ä¸ª\n`;
                    message += `ğŸ”„ è¦†ç›–ï¼š${stats.updated} ä¸ª\n`;
                    if (stats.failed > 0) {
                        message += `âŒ å¤±è´¥ï¼š${stats.failed} ä¸ª\n\n`;
                        message += `å¤±è´¥è¯¦æƒ…ï¼š\n`;
                        stats.errors.forEach(err => {
                            message += `- ${err.app}: ${err.error}\n`;
                        });
                    }

                    if (stats.created > 0 || stats.updated > 0) {
                        message += `\næç¤ºï¼šå¯¼å…¥çš„åº”ç”¨éœ€è¦åœ¨"ä»¤ç‰Œç®¡ç†"é¡µé¢æ‰‹åŠ¨ç»‘å®šè®¿é—®æƒé™ã€‚`;
                    }

                    showNotification(message, stats.failed > 0 ? 'error' : 'success');
                } else {
                    showNotification('å¯¼å…¥å¤±è´¥ï¼š' + result.error, 'error');
                }
            } catch (error) {
                console.error('Import failed:', error);
                showNotification('å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        loadApps();
    </script>

{% include '_footer.html' %}
</body>
</html>