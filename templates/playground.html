<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Playground - UniMCPSim</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="/static/js/monaco-editor/vs/loader.js"></script>
    <style>
        /* Playground ä¸“ç”¨æ ·å¼ */
        .playground-container {
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 1.5rem;
            height: calc(100vh - 120px);
            min-height: 600px;
        }

        .playground-left, .playground-right {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .playground-section {
            background: var(--bg-100);
            border: 1px solid var(--bg-300);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .playground-section-header {
            background: var(--bg-200);
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: var(--primary-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bg-300);
        }

        .playground-section-body {
            padding: 0;
        }

        /* ç¼–è¾‘å™¨å®¹å™¨ */
        .editor-container {
            height: 200px;
            border: none;
        }

        .editor-container-large {
            height: 180px;
        }

        /* å·¥å…·åˆ—è¡¨ */
        .tools-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .tool-item {
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            background: var(--bg-200);
        }

        .tool-item:hover {
            background: var(--bg-300);
        }

        .tool-name {
            font-weight: 600;
            color: var(--primary-100);
        }

        .tool-description {
            font-size: 0.85rem;
            color: var(--text-200);
            margin-top: 0.25rem;
        }

        .tool-params {
            font-size: 0.8rem;
            color: var(--text-200);
            margin-top: 0.25rem;
        }

        /* å¯¹è¯åŒºåŸŸ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-200);
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            max-width: 90%;
        }

        .chat-message.user {
            background: var(--primary-100);
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: var(--bg-100);
            border: 1px solid var(--bg-300);
        }

        .chat-message.tool-call {
            background: #fff3cd;
            border: 1px solid #ffc107;
            font-size: 0.85rem;
        }

        .chat-message.tool-result {
            background: #d4edda;
            border: 1px solid #28a745;
            font-size: 0.85rem;
        }

        .chat-message.error {
            background: #f8d7da;
            border: 1px solid #dc3545;
        }

        .chat-message-label {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            opacity: 0.7;
        }

        .chat-message-content {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .chat-message pre {
            background: var(--bg-200);
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.85rem;
            margin: 0.5rem 0;
        }

        .chat-message.assistant pre {
            background: var(--bg-200);
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-container {
            padding: 1rem;
            background: var(--bg-100);
            border-top: 1px solid var(--bg-300);
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--bg-300);
            border-radius: 6px;
            font-size: 0.95rem;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-100);
        }

        /* çŠ¶æ€æç¤º */
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .status-badge.connected {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.connecting {
            background: #fff3cd;
            color: #856404;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-300);
            border-top-color: var(--primary-100);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-200);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 1024px) {
            .playground-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .playground-left, .playground-right {
                height: auto;
                min-height: 400px;
            }
        }

        /* å·¥å…·è°ƒç”¨æ ·å¼ */
        .tool-call-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }

        .tool-call-name {
            font-weight: 600;
            color: var(--primary-100);
        }

        .tool-call-args {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-200);
        }

        /* æŒ‰é’®ç»„ */
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
{% include '_navigation.html' %}

<div class="container mt-3">
    <div class="playground-container">
        <!-- å·¦ä¾§ï¼šé…ç½®åŒºåŸŸ -->
        <div class="playground-left">
            <!-- ç³»ç»Ÿæç¤ºè¯ -->
            <div class="playground-section" style="flex: 0 0 auto;">
                <div class="playground-section-header">
                    <span>ç³»ç»Ÿæç¤ºè¯</span>
                    <button class="btn btn-sm btn-secondary" onclick="resetSystemPrompt()">é‡ç½®</button>
                </div>
                <div class="playground-section-body">
                    <div id="systemPromptEditor" class="editor-container"></div>
                </div>
            </div>

            <!-- MCP Server é…ç½® -->
            <div class="playground-section" style="flex: 0 0 auto;">
                <div class="playground-section-header">
                    <span>MCP Server é…ç½®</span>
                    <div class="btn-group">
                        <span id="connectionStatus" class="status-badge disconnected">æœªè¿æ¥</span>
                        <button id="testBtn" class="btn btn-sm btn-primary" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                    </div>
                </div>
                <div class="playground-section-body">
                    <div id="mcpConfigEditor" class="editor-container-large"></div>
                </div>
            </div>

            <!-- å·²è¿æ¥çš„å·¥å…·åˆ—è¡¨ -->
            <div class="playground-section" style="flex: 1; min-height: 150px; display: flex; flex-direction: column;">
                <div class="playground-section-header">
                    <span>å¯ç”¨å·¥å…· (<span id="toolCount">0</span>)</span>
                </div>
                <div class="playground-section-body tools-list" id="toolsList" style="flex: 1;">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”§</div>
                        <p>è¯·å…ˆé…ç½®å¹¶æµ‹è¯• MCP Server è¿æ¥</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå¯¹è¯åŒºåŸŸ -->
        <div class="playground-right">
            <div class="playground-section chat-container">
                <div class="playground-section-header">
                    <span>å¯¹è¯æµ‹è¯•</span>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-secondary" onclick="clearChat()">æ¸…é™¤å¯¹è¯</button>
                    </div>
                </div>

                <!-- æ¶ˆæ¯åˆ—è¡¨ -->
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <p>å¼€å§‹ä¸å¤§æ¨¡å‹å¯¹è¯<br>å¤§æ¨¡å‹ä¼šè‡ªåŠ¨è°ƒç”¨ MCP å·¥å…·æ¥å®Œæˆä»»åŠ¡</p>
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="chat-input-container">
                    <textarea
                        id="chatInput"
                        class="chat-input"
                        placeholder="è¾“å…¥æ¶ˆæ¯...ï¼ˆæŒ‰ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œï¼‰"
                        rows="2"
                    ></textarea>
                    <button id="sendBtn" class="btn btn-primary" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% include '_footer.html' %}

<script>
    // å…¨å±€å˜é‡
    let systemPromptEditor = null;
    let mcpConfigEditor = null;
    let isConnected = false;
    let isSending = false;

    // é»˜è®¤ MCP é…ç½®ç¤ºä¾‹
    const defaultMcpConfig = {
        "mcpServers": {
            "example": {
                "name": "ç¤ºä¾‹ MCP Server",
                "type": "streamableHttp",
                "description": "è¯·æ›¿æ¢ä¸ºå®é™…çš„ MCP Server é…ç½®",
                "isActive": true,
                "baseUrl": "http://127.0.0.1:{{ mcp_port }}/Category/AppName?token=YOUR_TOKEN_HERE"
            }
        }
    };

    // åˆå§‹åŒ– Monaco Editor
    require.config({ paths: { vs: '/static/js/monaco-editor/vs' } });
    require(['vs/editor/editor.main'], function() {
        // ç³»ç»Ÿæç¤ºè¯ç¼–è¾‘å™¨
        systemPromptEditor = monaco.editor.create(document.getElementById('systemPromptEditor'), {
            value: '',
            language: 'markdown',
            theme: 'vs',
            fontSize: 13,
            lineNumbers: 'off',
            minimap: { enabled: false },
            automaticLayout: true,
            scrollBeyondLastLine: false,
            wordWrap: 'on',
            lineHeight: 20
        });

        // MCP é…ç½®ç¼–è¾‘å™¨
        mcpConfigEditor = monaco.editor.create(document.getElementById('mcpConfigEditor'), {
            value: JSON.stringify(defaultMcpConfig, null, 2),
            language: 'json',
            theme: 'vs',
            fontSize: 13,
            lineNumbers: 'on',
            minimap: { enabled: false },
            automaticLayout: true,
            scrollBeyondLastLine: false,
            wordWrap: 'on',
            tabSize: 2
        });

        // åŠ è½½é»˜è®¤ç³»ç»Ÿæç¤ºè¯
        loadDefaultSystemPrompt();
    });

    // åŠ è½½é»˜è®¤ç³»ç»Ÿæç¤ºè¯
    async function loadDefaultSystemPrompt() {
        try {
            const response = await fetch('/admin/api/playground/system-prompt');
            const data = await response.json();
            if (data.prompt && systemPromptEditor) {
                systemPromptEditor.setValue(data.prompt);
            }
        } catch (error) {
            console.error('åŠ è½½é»˜è®¤ç³»ç»Ÿæç¤ºè¯å¤±è´¥:', error);
        }
    }

    // é‡ç½®ç³»ç»Ÿæç¤ºè¯
    function resetSystemPrompt() {
        loadDefaultSystemPrompt();
        showNotification('ç³»ç»Ÿæç¤ºè¯å·²é‡ç½®', 'success');
    }

    // æµ‹è¯• MCP è¿æ¥
    async function testConnection() {
        const testBtn = document.getElementById('testBtn');
        const statusBadge = document.getElementById('connectionStatus');

        try {
            // è§£æé…ç½®
            let config;
            try {
                config = JSON.parse(mcpConfigEditor.getValue());
            } catch (e) {
                showNotification('MCP é…ç½® JSON æ ¼å¼é”™è¯¯', 'error');
                return;
            }

            // æ›´æ–°çŠ¶æ€
            testBtn.disabled = true;
            testBtn.innerHTML = '<span class="loading-indicator"></span>';
            statusBadge.className = 'status-badge connecting';
            statusBadge.textContent = 'è¿æ¥ä¸­...';

            const response = await fetch('/admin/api/playground/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ config: config })
            });

            const result = await response.json();

            if (result.success) {
                isConnected = true;
                statusBadge.className = 'status-badge connected';
                statusBadge.textContent = 'å·²è¿æ¥';

                // æ›´æ–°å·¥å…·åˆ—è¡¨
                updateToolsList(result);

                showNotification(`è¿æ¥æˆåŠŸï¼å…±å‘ç° ${result.summary.total_tools} ä¸ªå·¥å…·`, 'success');
            } else {
                isConnected = false;
                statusBadge.className = 'status-badge disconnected';
                statusBadge.textContent = 'è¿æ¥å¤±è´¥';
                showNotification(result.error || 'è¿æ¥å¤±è´¥', 'error');
            }

        } catch (error) {
            console.error('æµ‹è¯•è¿æ¥å¤±è´¥:', error);
            statusBadge.className = 'status-badge disconnected';
            statusBadge.textContent = 'è¿æ¥å¤±è´¥';
            showNotification('è¿æ¥å¤±è´¥: ' + error.message, 'error');
        } finally {
            testBtn.disabled = false;
            testBtn.textContent = 'æµ‹è¯•è¿æ¥';
        }
    }

    // æ›´æ–°å·¥å…·åˆ—è¡¨
    function updateToolsList(result) {
        const toolsList = document.getElementById('toolsList');
        const toolCount = document.getElementById('toolCount');

        if (!result.results || result.results.length === 0) {
            toolsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”§</div><p>æœªæ‰¾åˆ°å¯ç”¨å·¥å…·</p></div>';
            toolCount.textContent = '0';
            return;
        }

        let html = '';
        let totalTools = 0;

        for (const serverResult of result.results) {
            if (!serverResult.success) continue;

            const tools = serverResult.tools || [];
            totalTools += tools.length;

            for (const tool of tools) {
                const params = tool.inputSchema?.properties
                    ? Object.keys(tool.inputSchema.properties).join(', ')
                    : 'æ— å‚æ•°';

                html += `
                    <div class="tool-item">
                        <div class="tool-name">${tool.name}</div>
                        <div class="tool-description">${tool.description || 'æ— æè¿°'}</div>
                        <div class="tool-params">å‚æ•°: ${params}</div>
                    </div>
                `;
            }
        }

        if (html) {
            toolsList.innerHTML = html;
        } else {
            toolsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”§</div><p>æœªæ‰¾åˆ°å¯ç”¨å·¥å…·</p></div>';
        }

        toolCount.textContent = totalTools.toString();
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
        if (isSending) return;

        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message) return;

        if (!isConnected) {
            showNotification('è¯·å…ˆè¿æ¥ MCP Server', 'error');
            return;
        }

        try {
            isSending = true;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading-indicator"></span>';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessage('user', message);
            input.value = '';

            // è·å–ç³»ç»Ÿæç¤ºè¯
            const systemPrompt = systemPromptEditor.getValue();

            // å‘é€è¯·æ±‚
            const response = await fetch('/admin/api/playground/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    system_prompt: systemPrompt
                })
            });

            const result = await response.json();

            if (result.success) {
                // æ˜¾ç¤ºå·¥å…·è°ƒç”¨äº‹ä»¶
                if (result.events && result.events.length > 0) {
                    for (const event of result.events) {
                        if (event.type === 'tool_call') {
                            addMessage('tool-call', `è°ƒç”¨å·¥å…·: ${event.tool_name}`, event.arguments);
                        } else if (event.type === 'tool_result') {
                            addMessage('tool-result', `å·¥å…·è¿”å›ç»“æœ`, event.result);
                        }
                    }
                }

                // æ˜¾ç¤ºåŠ©æ‰‹å›å¤
                if (result.response) {
                    addMessage('assistant', result.response);
                }
            } else {
                addMessage('error', result.error || 'è¯·æ±‚å¤±è´¥');
            }

        } catch (error) {
            console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            addMessage('error', 'å‘é€å¤±è´¥: ' + error.message);
        } finally {
            isSending = false;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = false;
            sendBtn.textContent = 'å‘é€';
        }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
    function addMessage(type, content, data = null) {
        const messagesContainer = document.getElementById('chatMessages');

        // ç§»é™¤ç©ºçŠ¶æ€æç¤º
        const emptyState = messagesContainer.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${type}`;

        let label = '';
        switch (type) {
            case 'user':
                label = 'ç”¨æˆ·';
                break;
            case 'assistant':
                label = 'AI åŠ©æ‰‹';
                break;
            case 'tool-call':
                label = 'ğŸ”§ å·¥å…·è°ƒç”¨';
                break;
            case 'tool-result':
                label = 'ğŸ“‹ å·¥å…·ç»“æœ';
                break;
            case 'error':
                label = 'âŒ é”™è¯¯';
                break;
        }

        let htmlContent = `<div class="chat-message-label">${label}</div>`;

        if (type === 'tool-call' || type === 'tool-result') {
            htmlContent += `<div class="chat-message-content">${content}</div>`;
            if (data) {
                htmlContent += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        } else {
            // ç®€å•çš„ Markdown å¤„ç†ï¼šä»£ç å—
            let formattedContent = content;
            formattedContent = formattedContent.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            formattedContent = formattedContent.replace(/`([^`]+)`/g, '<code>$1</code>');
            htmlContent += `<div class="chat-message-content">${formattedContent}</div>`;
        }

        messageDiv.innerHTML = htmlContent;
        messagesContainer.appendChild(messageDiv);

        // æ»šåŠ¨åˆ°åº•éƒ¨
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // æ¸…é™¤å¯¹è¯
    async function clearChat() {
        try {
            await fetch('/admin/api/playground/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            // æ¸…ç©ºç•Œé¢
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ’¬</div>
                    <p>å¼€å§‹ä¸å¤§æ¨¡å‹å¯¹è¯<br>å¤§æ¨¡å‹ä¼šè‡ªåŠ¨è°ƒç”¨ MCP å·¥å…·æ¥å®Œæˆä»»åŠ¡</p>
                </div>
            `;

            showNotification('å¯¹è¯å·²æ¸…é™¤', 'success');
        } catch (error) {
            console.error('æ¸…é™¤å¯¹è¯å¤±è´¥:', error);
            showNotification('æ¸…é™¤å¤±è´¥', 'error');
        }
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info') {
        const icons = {
            success: 'âœ…',
            error: 'âŒ',
            info: 'â„¹ï¸'
        };

        const notification = document.createElement('div');
        notification.className = `notification-toast ${type}`;
        notification.innerHTML = `
            <span class="notification-icon">${icons[type] || icons.info}</span>
            <div class="notification-content">${message}</div>
            <button class="notification-close" onclick="this.parentElement.remove()">âœ•</button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }

    // è¾“å…¥æ¡†äº‹ä»¶å¤„ç†
    document.addEventListener('DOMContentLoaded', function() {
        const chatInput = document.getElementById('chatInput');

        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    });
</script>
</body>
</html>
