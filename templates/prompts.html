<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提示词管理 - UniMCPSim</title>
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
{% include '_navigation.html' %}

    <div class="container mt-3">
        <div class="card">
            <div class="card-header">
                <span>提示词模板管理</span>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>显示名称</th>
                        <th>描述</th>
                        <th>状态</th>
                        <th>更新时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="promptsList">
                    <!-- 动态加载 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 编辑提示词模态框 -->
    <div class="modal" id="promptModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">编辑提示词模板</h3>
            </div>

            <form id="promptForm">
                <input type="hidden" id="promptId" value="">
                <input type="hidden" id="promptName" value="">

                <!-- 基本信息（只读显示） -->
                <div class="card" style="margin-bottom: 1rem; background-color: var(--bg-200);">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div>
                            <label class="form-label" style="margin-bottom: 0.3rem; font-size: 0.85rem; color: var(--text-200);">模板标识</label>
                            <div style="font-weight: 500;"><code id="displayPromptName"></code></div>
                        </div>
                        <div>
                            <label class="form-label" style="margin-bottom: 0.3rem; font-size: 0.85rem; color: var(--text-200);">显示名称</label>
                            <div style="font-weight: 500;" id="displayPromptDisplayName"></div>
                        </div>
                        <div>
                            <label class="form-label" style="margin-bottom: 0.3rem; font-size: 0.85rem; color: var(--text-200);">描述</label>
                            <div style="color: var(--text-200); font-size: 0.9rem;" id="displayPromptDescription"></div>
                        </div>
                    </div>
                </div>

                <!-- 系统变量说明 -->
                <div class="card" style="margin-bottom: 1rem; padding: 0.8rem;">
                    <div style="font-size: 0.9rem; color: var(--text-200); margin-bottom: 0.5rem;">
                        <strong>可用系统变量：</strong>
                    </div>
                    <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.85rem;">
                        <span><code>{app_name}</code> 应用名称</span>
                        <span><code>{action}</code> 动作名称</span>
                        <span><code>{parameters}</code> 用户参数(JSON)</span>
                        <span><code>{action_definition}</code> 动作定义(JSON)</span>
                    </div>
                </div>

                <!-- 提示词编辑器（全宽） -->
                <div class="form-group">
                    <label class="form-label">提示词模板内容</label>
                    <textarea id="promptTemplate" class="form-control" rows="18" placeholder="输入提示词模板内容，使用 {变量名} 格式引用系统变量..." style="font-family: monospace; font-size: 0.9rem;"></textarea>
                </div>

                <div class="form-group" style="text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存模板</button>
                </div>
            </form>
        </div>
    </div>

{% include '_footer.html' %}

    <script>
        let currentPromptId = null;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadPrompts();
        });

        // 加载提示词列表
        async function loadPrompts() {
            try {
                const response = await fetch('/admin/api/prompts');
                const prompts = await response.json();
                const tbody = document.getElementById('promptsList');

                tbody.innerHTML = prompts.map(prompt => `
                    <tr>
                        <td><code>${prompt.name}</code></td>
                        <td>${prompt.display_name}</td>
                        <td>${prompt.description || '无描述'}</td>
                        <td>
                            <span class="badge ${prompt.enabled ? 'badge-success' : 'badge-danger'}">
                                ${prompt.enabled ? '启用' : '禁用'}
                            </span>
                        </td>
                        <td>${new Date(prompt.updated_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="editPrompt('${prompt.name}')">编辑</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load prompts:', error);
            }
        }


        // 编辑提示词
        async function editPrompt(name) {
            try {
                const response = await fetch(`/admin/api/prompts/${name}`);
                const prompt = await response.json();

                currentPromptId = prompt.id;
                document.getElementById('modalTitle').textContent = '编辑提示词模板 - ' + prompt.display_name;
                document.getElementById('promptId').value = prompt.id;
                document.getElementById('promptName').value = prompt.name;

                // 显示只读信息
                document.getElementById('displayPromptName').textContent = prompt.name;
                document.getElementById('displayPromptDisplayName').textContent = prompt.display_name;
                document.getElementById('displayPromptDescription').textContent = prompt.description || '无描述';

                // 可编辑内容
                document.getElementById('promptTemplate').value = prompt.template;

                showModal();
            } catch (error) {
                console.error('Failed to load prompt:', error);
            }
        }


        // 提交表单
        document.getElementById('promptForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const promptName = document.getElementById('promptName').value;

            // 只提交模板内容，其他字段从已有数据中获取
            const data = {
                name: promptName,
                template: document.getElementById('promptTemplate').value
            };

            try {
                const response = await fetch('/admin/api/prompts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    hideModal();
                    loadPrompts();
                } else {
                    const error = await response.json();
                    alert('保存失败: ' + (error.error || '未知错误'));
                }
            } catch (error) {
                console.error('Failed to save prompt:', error);
                alert('保存失败');
            }
        });

        // 显示模态框
        function showModal() {
            document.getElementById('promptModal').classList.add('show');
        }

        // 隐藏模态框
        function hideModal() {
            document.getElementById('promptModal').classList.remove('show');
        }
    </script>
</body>
</html>