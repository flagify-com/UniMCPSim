<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大模型配置 - UniMCPSim</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .form-row {
            display: flex;
            gap: 1.5rem;
        }
        .form-row .form-group {
            flex: 1;
        }
        .collapsible-info {
            margin-bottom: 1.5rem;
        }
        .collapsible-info summary {
            cursor: pointer;
            padding: 0.8rem 1rem;
            background-color: var(--bg-200);
            border-left: 4px solid var(--primary);
            font-weight: 500;
            user-select: none;
        }
        .collapsible-info summary:hover {
            background-color: var(--bg-300);
        }
        .collapsible-info .info-content {
            padding: 1rem;
            background-color: var(--bg-100);
            border-left: 4px solid var(--primary);
            margin-top: 0;
        }
        .collapsible-info ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }
        .collapsible-info li {
            margin-bottom: 0.3rem;
        }
        .provider-hint {
            font-size: 0.85rem;
            color: var(--text-200);
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
{% include '_navigation.html' %}

    <div class="container mt-3">
        <div class="card">
            <div class="card-header">
                <span>大模型配置（OpenAI API兼容）</span>
            </div>

            <div style="padding: 1.5rem;">
                <!-- 可折叠的提示信息 -->
                <details class="collapsible-info">
                    <summary>ℹ️ 配置说明（点击展开）</summary>
                    <div class="info-content">
                        此配置支持所有兼容 OpenAI API 格式的大模型服务，包括：
                        <ul>
                            <li><strong>OpenAI</strong> - GPT-4o, GPT-4o-mini, GPT-4 等</li>
                            <li><strong>阿里云百炼</strong> - qwen-max, qwen-plus, qwq-32b 等</li>
                            <li><strong>智谱AI</strong> - glm-4, glm-4-flash, glm-4.6 等</li>
                            <li><strong>DeepSeek</strong> - deepseek-chat, deepseek-coder 等</li>
                            <li><strong>月之暗面</strong> - moonshot-v1-8k, moonshot-v1-32k 等</li>
                            <li><strong>豆包大模型</strong> - 需在火山引擎控制台获取模型ID</li>
                            <li><strong>硅基流动</strong> - 支持多种开源模型</li>
                            <li><strong>Google Gemini</strong> - gemini-pro, gemini-1.5-flash 等</li>
                            <li><strong>Ollama</strong> - 本地部署的开源模型</li>
                        </ul>
                    </div>
                </details>

                <form id="llmConfigForm">
                    <!-- 服务商选择 -->
                    <div class="form-group">
                        <label class="form-label">服务商</label>
                        <select id="provider" class="form-control" onchange="onProviderChange()">
                            <option value="custom">自定义</option>
                            <option value="openai">OpenAI</option>
                            <option value="aliyun">阿里云百炼</option>
                            <option value="zhipu">智谱AI</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="moonshot">月之暗面</option>
                            <option value="doubao">豆包大模型</option>
                            <option value="siliconflow">硅基流动</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="ollama">Ollama (本地)</option>
                        </select>
                        <div class="provider-hint" id="providerHint"></div>
                    </div>

                    <!-- API Base URL -->
                    <div class="form-group">
                        <label class="form-label required">API Base URL</label>
                        <input type="text" id="apiBaseUrl" class="form-control"
                               placeholder="https://api.openai.com/v1" required>
                    </div>

                    <!-- API Key -->
                    <div class="form-group">
                        <label class="form-label required">API Key</label>
                        <input type="password" id="apiKey" class="form-control"
                               placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" required>
                        <small class="form-text">您的API密钥（保存后将脱敏显示）</small>
                    </div>

                    <!-- Model Name -->
                    <div class="form-group">
                        <label class="form-label required">Model Name</label>
                        <input type="text" id="modelName" class="form-control"
                               placeholder="请输入模型名称" required>
                        <small class="form-text" id="modelHint">请查阅服务商文档获取可用模型列表</small>
                    </div>

                    <!-- Enable Thinking 和 Enable Stream 并排 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Enable Thinking</label>
                            <select id="enableThinking" class="form-control">
                                <option value="false">否（默认）</option>
                                <option value="true">是</option>
                            </select>
                            <small class="form-text">思考模式可能影响JSON输出</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Enable Stream</label>
                            <select id="enableStream" class="form-control">
                                <option value="false">否（默认）</option>
                                <option value="true">是</option>
                            </select>
                            <small class="form-text">某些模型强制要求启用</small>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="form-group" style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="testConnection()">测试连接</button>
                        <button type="submit" class="btn btn-primary">保存配置</button>
                    </div>
                </form>

                <!-- 测试结果显示区域 -->
                <div id="testResult" style="margin-top: 1.5rem; display: none;">
                    <div class="card">
                        <div class="card-header">
                            <span>测试结果</span>
                        </div>
                        <div style="padding: 1rem;">
                            <div id="testResultContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% include '_footer.html' %}

    <script>
        let originalApiKey = null;

        // 服务商配置
        const providers = {
            'custom': {
                url: '',
                hint: '请手动填写 API 地址'
            },
            'openai': {
                url: 'https://api.openai.com/v1',
                hint: '常用模型：gpt-4o, gpt-4o-mini, gpt-4-turbo'
            },
            'aliyun': {
                url: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
                hint: '常用模型：qwen-max, qwen-plus, qwq-32b'
            },
            'zhipu': {
                url: 'https://open.bigmodel.cn/api/paas/v4',
                hint: '常用模型：glm-4, glm-4-flash, glm-4.6'
            },
            'deepseek': {
                url: 'https://api.deepseek.com/v1',
                hint: '常用模型：deepseek-chat, deepseek-coder'
            },
            'moonshot': {
                url: 'https://api.moonshot.cn/v1',
                hint: '常用模型：moonshot-v1-8k, moonshot-v1-32k, moonshot-v1-128k'
            },
            'doubao': {
                url: 'https://ark.cn-beijing.volces.com/api/v3',
                hint: '模型ID需在火山引擎控制台创建推理接入点获取'
            },
            'siliconflow': {
                url: 'https://api.siliconflow.cn/v1',
                hint: '支持 Qwen、DeepSeek、Llama 等多种开源模型'
            },
            'gemini': {
                url: 'https://generativelanguage.googleapis.com/v1beta/openai',
                hint: '常用模型：gemini-1.5-flash, gemini-1.5-pro, gemini-pro'
            },
            'ollama': {
                url: 'http://localhost:11434/v1',
                hint: '本地部署，模型名称与 ollama list 显示的一致'
            }
        };

        // 服务商选择变化
        function onProviderChange() {
            const provider = document.getElementById('provider').value;
            const config = providers[provider];

            if (config) {
                if (config.url) {
                    document.getElementById('apiBaseUrl').value = config.url;
                }
                document.getElementById('providerHint').textContent = config.hint;
                document.getElementById('modelHint').textContent = config.hint;
            }
        }

        // 根据 URL 反推服务商
        function detectProvider(url) {
            if (!url) return 'custom';
            for (const [key, config] of Object.entries(providers)) {
                if (config.url && url.includes(new URL(config.url).host)) {
                    return key;
                }
            }
            return 'custom';
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
        });

        // 加载配置
        async function loadConfig() {
            try {
                const response = await fetch('/admin/api/llm-config');
                const config = await response.json();

                if (config.api_key) {
                    originalApiKey = config.api_key;
                    document.getElementById('apiKey').value = config.api_key;
                    document.getElementById('apiKey').placeholder = '已配置（保持原值请勿修改）';
                }

                const apiBaseUrl = config.api_base_url || 'https://api.openai.com/v1';
                document.getElementById('apiBaseUrl').value = apiBaseUrl;
                document.getElementById('modelName').value = config.model_name || '';
                document.getElementById('enableThinking').value = config.enable_thinking ? 'true' : 'false';
                document.getElementById('enableStream').value = config.enable_stream ? 'true' : 'false';

                // 根据 URL 自动选择服务商
                const provider = detectProvider(apiBaseUrl);
                document.getElementById('provider').value = provider;
                onProviderChange();
            } catch (error) {
                console.error('Failed to load config:', error);
                alert('加载配置失败');
            }
        }

        // 提交表单
        document.getElementById('llmConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const apiKey = document.getElementById('apiKey').value;
            const apiBaseUrl = document.getElementById('apiBaseUrl').value;
            const modelName = document.getElementById('modelName').value;
            const enableThinking = document.getElementById('enableThinking').value === 'true';
            const enableStream = document.getElementById('enableStream').value === 'true';

            const finalApiKey = apiKey === originalApiKey ? originalApiKey : apiKey;

            const data = {
                api_key: finalApiKey,
                api_base_url: apiBaseUrl,
                model_name: modelName,
                enable_thinking: enableThinking,
                enable_stream: enableStream
            };

            try {
                const response = await fetch('/admin/api/llm-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message || '配置保存成功');
                    loadConfig();
                } else {
                    alert('保存失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('Failed to save config:', error);
                alert('保存失败');
            }
        });

        // 测试连接
        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value;
            const apiBaseUrl = document.getElementById('apiBaseUrl').value;
            const modelName = document.getElementById('modelName').value;
            const enableThinking = document.getElementById('enableThinking').value === 'true';
            const enableStream = document.getElementById('enableStream').value === 'true';

            if (!apiKey || !apiBaseUrl || !modelName) {
                alert('请填写完整的配置信息');
                return;
            }

            const testResult = document.getElementById('testResult');
            const testResultContent = document.getElementById('testResultContent');
            testResult.style.display = 'block';
            testResultContent.innerHTML = '<div style="text-align: center; padding: 1rem;"><span style="color: var(--primary);">测试中，请稍候...</span></div>';

            const data = {
                api_key: apiKey,
                api_base_url: apiBaseUrl,
                model_name: modelName,
                enable_thinking: enableThinking,
                enable_stream: enableStream
            };

            try {
                const response = await fetch('/admin/api/llm-config/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    const responseText = result.response || '(模型未返回内容，但连接成功)';
                    testResultContent.innerHTML = `
                        <div style="color: var(--success);">
                            <strong>✓ ${result.message}</strong>
                            <div style="margin-top: 0.5rem; padding: 0.8rem; background-color: var(--bg-200); border-radius: 4px;">
                                <div style="margin-bottom: 0.5rem;"><strong>模型：</strong>${result.model}</div>
                                <div style="margin-bottom: 0.5rem;"><strong>响应时间：</strong>${result.duration}</div>
                                <div style="margin-bottom: 0.3rem;"><strong>模型响应：</strong></div>
                                <div style="padding: 0.5rem; background-color: var(--bg-100); border-left: 3px solid var(--primary); white-space: pre-wrap; word-break: break-word;">${responseText}</div>
                            </div>
                        </div>
                    `;
                } else {
                    testResultContent.innerHTML = `
                        <div style="color: var(--danger);">
                            <strong>✗ 测试失败</strong>
                            <div style="margin-top: 0.5rem; padding: 0.8rem; background-color: var(--bg-200); border-radius: 4px; color: var(--text-100);">
                                ${result.error || '未知错误'}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Test failed:', error);
                testResultContent.innerHTML = `
                    <div style="color: var(--danger);">
                        <strong>✗ 测试失败</strong>
                        <div style="margin-top: 0.5rem; padding: 0.8rem; background-color: var(--bg-200); border-radius: 4px; color: var(--text-100);">
                            ${error.message || '网络错误'}
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
